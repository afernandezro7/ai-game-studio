name: Release Manager ğŸ·ï¸ğŸš€
run-name: "Release ${{ github.event.pull_request.title }}"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-and-deploy:
    if: >
      github.event.pull_request.merged == true
      && !contains(join(github.event.pull_request.labels.*.name, ', '), 'skip-release')
      && (contains(join(github.event.pull_request.labels.*.name, ', '), 'release:major')
       || contains(join(github.event.pull_request.labels.*.name, ', '), 'release:minor')
       || contains(join(github.event.pull_request.labels.*.name, ', '), 'release:patch'))
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.NEW_VERSION }}
      bump_type: ${{ steps.bump.outputs.BUMP_TYPE }}
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js ğŸ”§
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: ./package-lock.json

      - name: Determine Version Bump ğŸ”
        id: bump
        run: |
          BUMP_TYPE="none"
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'release:major') }}" == "true" ]]; then
            BUMP_TYPE="major"
          elif [[ "${{ contains(github.event.pull_request.labels.*.name, 'release:minor') }}" == "true" ]]; then
            BUMP_TYPE="minor"
          elif [[ "${{ contains(github.event.pull_request.labels.*.name, 'release:patch') }}" == "true" ]]; then
            BUMP_TYPE="patch"
          fi

          echo "BUMP_TYPE=$BUMP_TYPE" >> "$GITHUB_OUTPUT"
          echo "BUMP_TYPE=$BUMP_TYPE" >> "$GITHUB_ENV"
          echo "## Version Bump: \`$BUMP_TYPE\`" >> "$GITHUB_STEP_SUMMARY"

      - name: Configure Git User ğŸ‘¤
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump Version & Push Tag ğŸ“¦
        id: version
        run: |
          # Get current version before bump
          OLD_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $OLD_VERSION"

          # Bump root package.json (creates commit + tag)
          npm version $BUMP_TYPE -m "chore(release): v%s [skip ci]"

          # Sync client-web version to match root
          NEW_VERSION=$(node -p "require('./package.json').version")
          cd client-web
          npm version $NEW_VERSION --no-git-tag-version
          cd ..

          # Amend the commit to include client-web update
          git add client-web/package.json
          git commit --amend --no-edit

          # Force update the tag to point to amended commit
          git tag -f "v${NEW_VERSION}"

          # Push commit and tags back to main
          git push origin main --follow-tags --force

          echo "NEW_VERSION=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "## Released: v$OLD_VERSION â†’ v$NEW_VERSION" >> "$GITHUB_STEP_SUMMARY"

      - name: Create GitHub Release ğŸ·ï¸
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.NEW_VERSION }}"
          gh release create "v${NEW_VERSION}" \
            --title "v${NEW_VERSION}" \
            --generate-notes \
            --target main
          echo "## [GitHub Release v${NEW_VERSION}](https://github.com/${{ github.repository }}/releases/tag/v${NEW_VERSION})" >> "$GITHUB_STEP_SUMMARY"

      - name: Install Dependencies ğŸ“¦
        run: npm ci

      - name: Build Project ğŸ—ï¸
        run: |
          cd client-web
          npm run build

      - name: Deploy to GitHub Pages ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: client-web/dist
          branch: gh-pages
          clean: true

      - name: Comment Release in PR ğŸ’¬
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.NEW_VERSION }}"
          gh pr comment ${{ github.event.pull_request.number }} --body \
            "## ğŸš€ Release v${NEW_VERSION} published!

            - **Tag**: [\`v${NEW_VERSION}\`](https://github.com/${{ github.repository }}/releases/tag/v${NEW_VERSION})
            - **Deploy**: [GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)
            - **Bump type**: \`$BUMP_TYPE\`"

  sync-develop:
    name: Sync main â†’ develop ğŸ”„
    needs: release-and-deploy
    if: always() && needs.release-and-deploy.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git User ğŸ‘¤
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Sync PR main â†’ develop ğŸ”„
        id: sync-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ needs.release-and-deploy.outputs.new_version }}"
          SYNC_BRANCH="automated/sync-v${NEW_VERSION}-to-develop"

          # Check if develop exists
          if ! git ls-remote --heads origin develop | grep -q develop; then
            echo "develop branch does not exist. Skipping sync."
            exit 0
          fi

          # Create sync branch from main
          git checkout -b "$SYNC_BRANCH"
          git push -u origin "$SYNC_BRANCH"

          # Create PR
          gh pr create \
            --base develop \
            --head "$SYNC_BRANCH" \
            --title "ğŸ”„ Sync release v${NEW_VERSION} to develop" \
            --body "**Automated Pull Request**

            Syncs release \`v${NEW_VERSION}\` changes from \`main\` back to \`develop\`.

            This PR was created automatically after the release. Please review and merge to keep \`develop\` up to date.

            ---
            _Created by Release Manager workflow_" \
            --label "sync"

      - name: Comment if sync failed âš ï¸
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body \
            "âš ï¸ **Sync to develop failed**

            The automatic sync PR from \`main\` to \`develop\` could not be created.
            Please manually create a branch from \`main\` and open a PR against \`develop\` to sync the release changes."
