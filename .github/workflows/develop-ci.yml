name: Develop CI

concurrency:
  group: develop-ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: ["develop"]
  pull_request:
    branches: ["develop"]

jobs:
  validate-json:
    name: Validate JSON Configs üìã
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON configurations
        run: |
          ERRORS=0
          for file in $(find games/*/config -name '*.json' 2>/dev/null); do
            echo "Validating $file..."
            if jq empty "$file" 2>/dev/null; then
              echo "‚úÖ $file is valid"
            else
              echo "‚ùå $file is invalid"
              ERRORS=$((ERRORS + 1))
            fi
          done
          if [ $ERRORS -gt 0 ]; then
            echo "::error::$ERRORS JSON file(s) failed validation"
            exit 1
          fi
          echo "All JSON configs valid ‚úÖ"

  typecheck-midgard-backend:
    name: TypeCheck Backend (Midgard Online) üîß
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install & TypeCheck
        working-directory: games/midgard-online/backend
        run: |
          npm ci
          npx tsc --noEmit

  typecheck-midgard-frontend:
    name: TypeCheck Frontend (Midgard Online) üé®
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install & TypeCheck
        working-directory: games/midgard-online/sandbox-web
        run: |
          npm ci
          npx tsc --noEmit

  validate-docs:
    name: Validate Docs üìù
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Markdown Link Check
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: "yes"
          use-verbose-mode: "yes"
          config-file: "mlc_config.json"
          folder-path: "games"
          file-path: "./README.md"
